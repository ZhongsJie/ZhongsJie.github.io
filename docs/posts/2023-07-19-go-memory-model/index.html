<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Go å†…å­˜æ¨¡å‹ä¸åˆ†é…æœºåˆ¶ | Atomage&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Goå†…å­˜æ¨¡å‹æŒ‡å®šäº†ä¸€ä¸ªgoroutineä¸­å˜é‡çš„è¯»å–æ¡ä»¶ï¼Œå¯ä»¥ä¿è¯è§‚å¯Ÿä¸åŒgoroutineä¸­å¯¹åŒä¸€å˜é‡çš„å†™å…¥äº§ç”Ÿçš„å€¼ã€‚ è™šæ‹Ÿå†…å­˜# è™šæ‹Ÿå†…å­˜æŠ€æœ¯æ˜¯æ“ä½œç³»ç»Ÿå®ç°çš„ä¸€ç§é«˜æ•ˆçš„ç‰©ç†å†…å­˜ç®¡ç†æ–¹å¼ è™šæ‹Ÿå†…å­˜é€šè¿‡é¡µè¡¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œé¡µè¡¨è®°å½•æ˜¯å¦åœ¨ç‰©ç†å†…å­˜ä¸Šï¼ˆæœ‰æ•ˆä½ï¼‰ï¼Œä»¥åŠç‰©ç†å†…å­˜é¡µçš„åœ°å€ æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼Œå› æ­¤ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´åœ°å€ï¼Œå¤šä¸ªè™šæ‹Ÿé¡µé¢å¯ä»¥æ˜ å°„åˆ°åŒä¸€ä¸ªå…±äº«ç‰©ç†é¡µé¢ä¸Šã€‚ åœ°å€ç¿»è¯‘ï¼šä¸€ä¸ªNå…ƒç´ çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å…ƒç´ å’Œä¸€ä¸ªMå…ƒç´ çš„ç‰©ç†åœ°å€ç©ºé—´ä¸­å…ƒç´ ä¹‹é—´çš„æ˜ å°„ è™šæ‹Ÿå†…å­˜ï¼šåˆ©ç”¨ç£ç›˜ç©ºé—´è™šæ‹Ÿå‡ºä¸€å—é€»è¾‘å†…å­˜ï¼Œç”¨ä½œè™šæ‹Ÿå†…å­˜çš„ç£ç›˜ç©ºé—´è¢«ç§°ä¸ºäº¤æ¢ç©ºé—´ æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†ä¸­ï¼Œä¸€ä¸ªé‡è¦æ¦‚å¿µè™šæ‹Ÿå†…å­˜: æ‰©å¤§åœ°">
    <meta name="generator" content="Hugo 0.115.3">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Go å†…å­˜æ¨¡å‹ä¸åˆ†é…æœºåˆ¶" />
<meta property="og:description" content="Goå†…å­˜æ¨¡å‹æŒ‡å®šäº†ä¸€ä¸ªgoroutineä¸­å˜é‡çš„è¯»å–æ¡ä»¶ï¼Œå¯ä»¥ä¿è¯è§‚å¯Ÿä¸åŒgoroutineä¸­å¯¹åŒä¸€å˜é‡çš„å†™å…¥äº§ç”Ÿçš„å€¼ã€‚ è™šæ‹Ÿå†…å­˜# è™šæ‹Ÿå†…å­˜æŠ€æœ¯æ˜¯æ“ä½œç³»ç»Ÿå®ç°çš„ä¸€ç§é«˜æ•ˆçš„ç‰©ç†å†…å­˜ç®¡ç†æ–¹å¼ è™šæ‹Ÿå†…å­˜é€šè¿‡é¡µè¡¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œé¡µè¡¨è®°å½•æ˜¯å¦åœ¨ç‰©ç†å†…å­˜ä¸Šï¼ˆæœ‰æ•ˆä½ï¼‰ï¼Œä»¥åŠç‰©ç†å†…å­˜é¡µçš„åœ°å€ æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼Œå› æ­¤ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´åœ°å€ï¼Œå¤šä¸ªè™šæ‹Ÿé¡µé¢å¯ä»¥æ˜ å°„åˆ°åŒä¸€ä¸ªå…±äº«ç‰©ç†é¡µé¢ä¸Šã€‚ åœ°å€ç¿»è¯‘ï¼šä¸€ä¸ªNå…ƒç´ çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å…ƒç´ å’Œä¸€ä¸ªMå…ƒç´ çš„ç‰©ç†åœ°å€ç©ºé—´ä¸­å…ƒç´ ä¹‹é—´çš„æ˜ å°„ è™šæ‹Ÿå†…å­˜ï¼šåˆ©ç”¨ç£ç›˜ç©ºé—´è™šæ‹Ÿå‡ºä¸€å—é€»è¾‘å†…å­˜ï¼Œç”¨ä½œè™šæ‹Ÿå†…å­˜çš„ç£ç›˜ç©ºé—´è¢«ç§°ä¸ºäº¤æ¢ç©ºé—´ æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†ä¸­ï¼Œä¸€ä¸ªé‡è¦æ¦‚å¿µè™šæ‹Ÿå†…å­˜: æ‰©å¤§åœ°" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blogs.atomage.cn/posts/2023-07-19-go-memory-model/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-19T13:10:33+08:00" />
<meta property="article:modified_time" content="2023-07-19T13:10:33+08:00" />
<meta itemprop="name" content="Go å†…å­˜æ¨¡å‹ä¸åˆ†é…æœºåˆ¶">
<meta itemprop="description" content="Goå†…å­˜æ¨¡å‹æŒ‡å®šäº†ä¸€ä¸ªgoroutineä¸­å˜é‡çš„è¯»å–æ¡ä»¶ï¼Œå¯ä»¥ä¿è¯è§‚å¯Ÿä¸åŒgoroutineä¸­å¯¹åŒä¸€å˜é‡çš„å†™å…¥äº§ç”Ÿçš„å€¼ã€‚ è™šæ‹Ÿå†…å­˜# è™šæ‹Ÿå†…å­˜æŠ€æœ¯æ˜¯æ“ä½œç³»ç»Ÿå®ç°çš„ä¸€ç§é«˜æ•ˆçš„ç‰©ç†å†…å­˜ç®¡ç†æ–¹å¼ è™šæ‹Ÿå†…å­˜é€šè¿‡é¡µè¡¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œé¡µè¡¨è®°å½•æ˜¯å¦åœ¨ç‰©ç†å†…å­˜ä¸Šï¼ˆæœ‰æ•ˆä½ï¼‰ï¼Œä»¥åŠç‰©ç†å†…å­˜é¡µçš„åœ°å€ æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼Œå› æ­¤ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´åœ°å€ï¼Œå¤šä¸ªè™šæ‹Ÿé¡µé¢å¯ä»¥æ˜ å°„åˆ°åŒä¸€ä¸ªå…±äº«ç‰©ç†é¡µé¢ä¸Šã€‚ åœ°å€ç¿»è¯‘ï¼šä¸€ä¸ªNå…ƒç´ çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å…ƒç´ å’Œä¸€ä¸ªMå…ƒç´ çš„ç‰©ç†åœ°å€ç©ºé—´ä¸­å…ƒç´ ä¹‹é—´çš„æ˜ å°„ è™šæ‹Ÿå†…å­˜ï¼šåˆ©ç”¨ç£ç›˜ç©ºé—´è™šæ‹Ÿå‡ºä¸€å—é€»è¾‘å†…å­˜ï¼Œç”¨ä½œè™šæ‹Ÿå†…å­˜çš„ç£ç›˜ç©ºé—´è¢«ç§°ä¸ºäº¤æ¢ç©ºé—´ æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†ä¸­ï¼Œä¸€ä¸ªé‡è¦æ¦‚å¿µè™šæ‹Ÿå†…å­˜: æ‰©å¤§åœ°"><meta itemprop="datePublished" content="2023-07-19T13:10:33+08:00" />
<meta itemprop="dateModified" content="2023-07-19T13:10:33+08:00" />
<meta itemprop="wordCount" content="4417">
<meta itemprop="keywords" content="Go,Memory," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go å†…å­˜æ¨¡å‹ä¸åˆ†é…æœºåˆ¶"/>
<meta name="twitter:description" content="Goå†…å­˜æ¨¡å‹æŒ‡å®šäº†ä¸€ä¸ªgoroutineä¸­å˜é‡çš„è¯»å–æ¡ä»¶ï¼Œå¯ä»¥ä¿è¯è§‚å¯Ÿä¸åŒgoroutineä¸­å¯¹åŒä¸€å˜é‡çš„å†™å…¥äº§ç”Ÿçš„å€¼ã€‚ è™šæ‹Ÿå†…å­˜# è™šæ‹Ÿå†…å­˜æŠ€æœ¯æ˜¯æ“ä½œç³»ç»Ÿå®ç°çš„ä¸€ç§é«˜æ•ˆçš„ç‰©ç†å†…å­˜ç®¡ç†æ–¹å¼ è™šæ‹Ÿå†…å­˜é€šè¿‡é¡µè¡¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œé¡µè¡¨è®°å½•æ˜¯å¦åœ¨ç‰©ç†å†…å­˜ä¸Šï¼ˆæœ‰æ•ˆä½ï¼‰ï¼Œä»¥åŠç‰©ç†å†…å­˜é¡µçš„åœ°å€ æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼Œå› æ­¤ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´åœ°å€ï¼Œå¤šä¸ªè™šæ‹Ÿé¡µé¢å¯ä»¥æ˜ å°„åˆ°åŒä¸€ä¸ªå…±äº«ç‰©ç†é¡µé¢ä¸Šã€‚ åœ°å€ç¿»è¯‘ï¼šä¸€ä¸ªNå…ƒç´ çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å…ƒç´ å’Œä¸€ä¸ªMå…ƒç´ çš„ç‰©ç†åœ°å€ç©ºé—´ä¸­å…ƒç´ ä¹‹é—´çš„æ˜ å°„ è™šæ‹Ÿå†…å­˜ï¼šåˆ©ç”¨ç£ç›˜ç©ºé—´è™šæ‹Ÿå‡ºä¸€å—é€»è¾‘å†…å­˜ï¼Œç”¨ä½œè™šæ‹Ÿå†…å­˜çš„ç£ç›˜ç©ºé—´è¢«ç§°ä¸ºäº¤æ¢ç©ºé—´ æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†ä¸­ï¼Œä¸€ä¸ªé‡è¦æ¦‚å¿µè™šæ‹Ÿå†…å­˜: æ‰©å¤§åœ°"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    



  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Atomage&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/archives/" title="â±ï¸Archives page">
              â±ï¸Archives
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="ğŸ“Posts page">
              ğŸ“Posts
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="ğŸ™‹ğŸ»â€â™‚ï¸About page">
              ğŸ™‹ğŸ»â€â™‚ï¸About
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    
    <a href="https://github.com/ZhongsJie96" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHubâ€”â€”Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      

<article class="flex-l flex-wrap justify-between mw8 center ph3">
  <header class="mt4 w-100">
    <aside class="instapaper_ignoref b helvetica tracked">
      
      ğŸ“POSTS
    </aside>
    










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


    <h1 class="f1 athelas mt3 mb1">Go å†…å­˜æ¨¡å‹ä¸åˆ†é…æœºåˆ¶</h1>
    
    <p class="tracked">
      By <strong>
        
        ZhongsJie
        
      </strong>
    </p>
    
    
    <time class="f6 mv4 dib tracked" datetime="2023-07-19T13:10:33+08:00" >July 19, 2023</time>

    
    
    <span class="f6 mv4 dib tracked"> - 9 minutes read</span>
    <span class="f6 mv4 dib tracked"> - 4417 words</span>
    
  </header>
  <div class="nested-copy-line-height lh-copy serif f4 nested-links
    nested-img mid-gray pr4-l w-100-l"><blockquote>
<p>Goå†…å­˜æ¨¡å‹æŒ‡å®šäº†ä¸€ä¸ªgoroutineä¸­å˜é‡çš„è¯»å–æ¡ä»¶ï¼Œå¯ä»¥ä¿è¯è§‚å¯Ÿä¸åŒgoroutineä¸­å¯¹åŒä¸€å˜é‡çš„å†™å…¥äº§ç”Ÿçš„å€¼ã€‚</p>
</blockquote>
<h2 id="è™šæ‹Ÿå†…å­˜">
    è™šæ‹Ÿå†…å­˜<a class="hash-link" href="#%e8%99%9a%e6%8b%9f%e5%86%85%e5%ad%98" title="Direct link to heading">#</a>
</h2><blockquote>
<p>è™šæ‹Ÿå†…å­˜æŠ€æœ¯æ˜¯æ“ä½œç³»ç»Ÿå®ç°çš„ä¸€ç§é«˜æ•ˆçš„ç‰©ç†å†…å­˜ç®¡ç†æ–¹å¼</p>
</blockquote>
<p><img src="/images/2023-07/%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80.png" alt="image-20200720222628264"></p>
<ul>
<li>è™šæ‹Ÿå†…å­˜é€šè¿‡<strong>é¡µè¡¨</strong>æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œé¡µè¡¨è®°å½•æ˜¯å¦åœ¨ç‰©ç†å†…å­˜ä¸Šï¼ˆ<strong>æœ‰æ•ˆä½</strong>ï¼‰ï¼Œä»¥åŠç‰©ç†å†…å­˜é¡µçš„åœ°å€</li>
<li>æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼Œå› æ­¤ä¹Ÿå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´åœ°å€ï¼Œå¤šä¸ªè™šæ‹Ÿé¡µé¢å¯ä»¥æ˜ å°„åˆ°åŒä¸€ä¸ªå…±äº«ç‰©ç†é¡µé¢ä¸Šã€‚</li>
<li><strong>åœ°å€ç¿»è¯‘</strong>ï¼šä¸€ä¸ªNå…ƒç´ çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å…ƒç´ å’Œä¸€ä¸ªMå…ƒç´ çš„ç‰©ç†åœ°å€ç©ºé—´ä¸­å…ƒç´ ä¹‹é—´çš„æ˜ å°„</li>
<li>è™šæ‹Ÿå†…å­˜ï¼šåˆ©ç”¨ç£ç›˜ç©ºé—´<strong>è™šæ‹Ÿå‡ºä¸€å—é€»è¾‘å†…å­˜</strong>ï¼Œç”¨ä½œè™šæ‹Ÿå†…å­˜çš„ç£ç›˜ç©ºé—´è¢«ç§°ä¸ºäº¤æ¢ç©ºé—´</li>
</ul>
<ol>
<li>æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†ä¸­ï¼Œä¸€ä¸ªé‡è¦æ¦‚å¿µè™šæ‹Ÿå†…å­˜:
<ul>
<li>æ‰©å¤§åœ°å€ç©ºé—´</li>
<li>å†…å­˜ä¿æŠ¤</li>
<li>å…¬å¹³å†…å­˜åˆ†é…</li>
<li>å½“è¿›ç¨‹é€šä¿¡æ—¶ï¼Œå¯é‡‡ç”¨è™šå­˜å…±äº«çš„æ–¹å¼å®ç°</li>
<li>ä¸éœ€è¦åœ¨å®é™…ç‰©ç†å†…å­˜çš„è¿ç»­ç©ºé—´ï¼Œ**å¯ä»¥åˆ©ç”¨ç¢ç‰‡</li>
</ul>
</li>
<li>è™šæ‹Ÿå†…å­˜çš„<strong>ä»£ä»·</strong>ï¼š
<ul>
<li>ç®¡ç†éœ€è¦å»ºç«‹å¾ˆå¤šæ•°æ®ç»“æ„ï¼Œå ç”¨é¢å¤–çš„å†…å­˜</li>
<li>è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ï¼Œå¢åŠ äº†æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´</li>
<li>é¡µé¢çš„æ¢å…¥æ¢å‡ºéœ€è¦ç£ç›˜I/O</li>
<li>ä¸€é¡µä¸­åªæœ‰éƒ¨åˆ†æ•°æ®ï¼Œä¼šæµªè´¹å†…å­˜</li>
</ul>
</li>
</ol>
<h2 id="goå†…å­˜æ¨¡å‹">
    Goå†…å­˜æ¨¡å‹<a class="hash-link" href="#go%e5%86%85%e5%ad%98%e6%a8%a1%e5%9e%8b" title="Direct link to heading">#</a>
</h2><blockquote>
<p>å‚è€ƒ<a href="https://github.com/google/tcmalloc/blob/master/docs/design.md">tcmalloc</a>è®¾è®¡ï¼Œã€Œä¿®æ”¹ç”±å¤šä¸ªgoroutineåŒæ—¶è®¿é—®çš„æ•°æ®çš„ç¨‹åºå¿…é¡»åºåˆ—åŒ–è¿™ç§è®¿é—®ã€‚ è¦åºåˆ—åŒ–è®¿é—®ï¼Œè¯·ä½¿ç”¨channelæ“ä½œæˆ–å…¶ä»–åŒæ­¥åŸè¯­ï¼ˆsyncå’Œsync/atomicï¼‰ä¿æŠ¤æ•°æ®ã€‚ åˆ«è‡ªä½œèªæ˜ã€‚ã€</p>
</blockquote>
<ol>
<li>tomallocä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹
<ul>
<li>å‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œé¿å…ä¸Šçº¿æ–‡åˆ‡æ¢</li>
<li>æ¯ä¸ªçº¿ç¨‹æœ‰ç¼“å­˜ï¼Œé¿å…äº†é”ç«äº‰</li>
<li>å¤æ‚çš„è®¾è®¡è®©å†…å­˜ç¢ç‰‡åŒ–ï¼Œå¹¶è®©å†…å­˜åˆ©ç”¨ç‡é™ä½ï¼Œtomallocåšäº†ä¸€å®šä¼˜åŒ–</li>
</ul>
</li>
</ol>
<h3 id="æ¦‚è¦">
    æ¦‚è¦<a class="hash-link" href="#%e6%a6%82%e8%a6%81" title="Direct link to heading">#</a>
</h3><blockquote>
<p>goçš„æ—©æœŸç‰ˆæœ¬é‡Œ &lt;= 1.10 ï¼Œå†…å­˜æ˜¯çº¿æ€§åˆ†é…çš„ï¼Œå°±æ˜¯å…ˆç”³è¯·ä¸€å—å¤§å†…å­˜ï¼Œç„¶åå†åˆ’åˆ†å„ç§å°å†…å­˜ï¼Œåœ¨&gt;=1.11ç‰ˆæœ¬ä¸­ï¼Œgolangä½¿ç”¨ç¨€ç–(åˆ†æ®µ)å†…å­˜</p>
</blockquote>
<p><img src="/images/2023-07/go%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png" alt="å†…å­˜æ¨¡å‹"></p>
<ol>
<li>å†…å­˜æ¨¡å‹æè¿°äº†ç¨‹åºæ‰§è¡Œçš„è¦æ±‚ï¼Œç¨‹åºæ‰§è¡Œç”± goroutine æ‰§è¡Œç»„æˆï¼Œè€Œ goroutine æ‰§è¡Œåˆç”±<strong>å†…å­˜æ“ä½œ</strong>ç»„æˆã€‚</li>
<li>å†…å­˜æ“ä½œï¼š
<ul>
<li>ç§ç±»ï¼šè¡¨æ˜æ˜¯æ™®é€šçš„æ•°æ®è¯»å–ã€æ™®é€šçš„æ•°æ®å†™å…¥ï¼Œè¿˜æ˜¯åŸå­æ•°æ®è®¿é—®ã€äº’æ–¥æ“ä½œã€é€šé“æ“ä½œç­‰åŒæ­¥æ“ä½œ</li>
<li>åœ¨ç¨‹åºä¸­çš„ä½ç½®</li>
<li>æ­£åœ¨è®¿é—®çš„å†…å­˜ä½ç½®æˆ–å˜é‡</li>
<li>æ“ä½œè¯»å–æˆ–å†™å…¥çš„å€¼</li>
</ul>
</li>
<li><code>mcache</code>ã€<code>mspan</code>ã€<code>mcentral</code> å’Œ <code>mheap</code> æ˜¯å†…å­˜ç®¡ç†çš„å››å¤§ç»„ä»¶ï¼Œ<code>mcache</code> ç®¡ç†çº¿ç¨‹åœ¨æœ¬åœ°ç¼“å­˜çš„ <code>mspan</code>ï¼Œè€Œ <code>mcentral</code> ç®¡ç†ç€å…¨å±€çš„ <code>mspan</code> ä¸ºæ‰€æœ‰ <code>mcache</code> æä¾›æ‰€æœ‰çº¿ç¨‹
<ul>
<li><code>mheap</code>ï¼šå…¨å±€çš„å†…å­˜èµ·æºï¼Œè®¿é—®è¦åŠ å…¨å±€é”</li>
<li><code>mcentral</code>ï¼šæ¯ç§å¯¹è±¡å¤§å°è§„æ ¼ï¼ˆå…¨å±€å…±åˆ’åˆ†ä¸º 68 ç§ï¼‰å¯¹åº”çš„ç¼“å­˜ï¼Œé”çš„ç²’åº¦ä¹Ÿä»…é™äºåŒä¸€ç§è§„æ ¼ä»¥å†… ï¼ˆä¸­å¿ƒç¼“å­˜ï¼‰</li>
<li><code>mcache</code>ï¼šGPMå…³ç³»ä¸­æ¯ä¸ªPæŒæœ‰ä¸€ä»½çš„å†…å­˜ç¼“å­˜ï¼Œmcache çš„æ•°é‡å°±æ˜¯P çš„æ•°é‡ï¼Œè®¿é—®æ—¶æ— é” ï¼ˆçº¿ç¨‹ç¼“å­˜ï¼‰
<img src="/images/2023-07/Pasted%20image%2020230714130617.png" alt=""></li>
</ul>
</li>
</ol>
<h3 id="mcache-çº¿ç¨‹ç¼“å­˜">
    <strong>mcache</strong> ï¼ˆçº¿ç¨‹ç¼“å­˜ï¼‰<a class="hash-link" href="#mcache-%e7%ba%bf%e7%a8%8b%e7%bc%93%e5%ad%98" title="Direct link to heading">#</a>
</h3><blockquote>
<p>æœ¬åœ°ç¼“å­˜mcacheå°±æ˜¯ä»ä¸­å¤®ç´¢å¼•ä¸­ï¼Œæ¯ä¸€ç§ç±»å‹çš„spanéƒ½æ‹¿å‡ºæ¥ä¸€ä¸ªç©ºé—²çš„spanæ¥ï¼Œæ”¾åœ¨æœ¬åœ°é˜Ÿåˆ—Pä¸­</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">mcache</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">NotInHeap</span>  <span style="color:#75715e">// ä¸ä¼šåˆ†é…åˆ°GCå †æˆ–è€…æ ˆä¸Š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¼šåœ¨æ¯æ¬¡è®¿é—®mallocæ—¶éƒ½ä¼šè¢«è®¿é—®ï¼Œæ‰€ä»¥ä¸ºäº†æ›´åŠ é«˜æ•ˆç¼“å­˜å°†å…¶æŒ‰ç»„æ”¾åœ¨è¿™é‡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">nextSample</span> <span style="color:#66d9ef">uintptr</span> <span style="color:#75715e">// åˆ†é…å¤šå°‘å¤§å°çš„å †æ—¶è§¦å‘å †é‡‡æ ·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">scanAlloc</span>  <span style="color:#66d9ef">uintptr</span> <span style="color:#75715e">// åˆ†é…çš„å¯æ‰«æå †å­—èŠ‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// å°å¯¹è±¡ç¼“å­˜, å½“ç”³è¯·å¯¹è±¡å¤§å°ä¸º `&lt;16KB` çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ `Tiny allocator` åˆ†é…å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">tiny</span>       <span style="color:#66d9ef">uintptr</span>  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">tinyoffset</span> <span style="color:#66d9ef">uintptr</span>  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">tinyAllocs</span> <span style="color:#66d9ef">uintptr</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ä¸‹æ–¹æˆå‘˜ä¸ä¼šåœ¨æ¯æ¬¡ malloc æ—¶è¢«è®¿é—®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">alloc</span> [<span style="color:#a6e22e">numSpanClasses</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">mspan</span>  <span style="color:#75715e">// å½“å‰Pçš„åˆ†é…è§„æ ¼ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">stackcache</span> [<span style="color:#a6e22e">_NumStackOrders</span>]<span style="color:#a6e22e">stackfreelist</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">flushGen</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Uint32</span>  <span style="color:#75715e">// è¡¨ç¤ºä¸Šæ¬¡åˆ·æ–°mcacheçš„sweepgenï¼ˆæ¸…æ‰«ç”Ÿæˆ)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ol>
<li><code>mcache.alloc</code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå€¼ä¸º <code>*spans</code> ç±»å‹ï¼Œå®ƒæ˜¯ go ä¸­ç®¡ç†å†…å­˜çš„åŸºæœ¬å•å…ƒã€‚å¯¹äº<code>16-32 kb</code>å¤§å°çš„å†…å­˜éƒ½ä¼šä½¿ç”¨è¿™ä¸ªæ•°ç»„é‡Œçš„çš„ <code>spans</code> ä¸­åˆ†é…ã€‚</li>
</ol>
<h3 id="mspan-ç®¡ç†å•å…ƒ">
    <strong>mspan</strong> ï¼ˆç®¡ç†å•å…ƒï¼‰<a class="hash-link" href="#mspan-%e7%ae%a1%e7%90%86%e5%8d%95%e5%85%83" title="Direct link to heading">#</a>
</h3><ol>
<li><code>mspan</code>ï¼šæœ€å°çš„ç®¡ç†å•å…ƒã€‚<code>mspan</code> å¤§å°ä¸º <code>page</code> ï¼ˆé¡µæœ€å°çš„å­˜å‚¨å•å…ƒï¼‰çš„æ•´æ•°å€ï¼Œä¸”ä» <code>8B</code> åˆ° <code>80KB</code> è¢«åˆ’åˆ†ä¸º <code>67</code> ç§ä¸åŒçš„è§„æ ¼ï¼Œåˆ†é…å¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ®å¤§å°æ˜ å°„åˆ°ä¸åŒè§„æ ¼çš„ mspanï¼Œä»ä¸­è·å–ç©ºé—´.</li>
<li>æºç é‡Œå®šä¹‰çš„è™½ç„¶æ˜¯ <code>_NumSizeClasses = 68</code> ç±»ï¼Œä½†å…¶ä¸­åŒ…å«ä¸€ä¸ªå¤§å°ä¸º <code>0</code> çš„è§„æ ¼ï¼Œæ­¤è§„æ ¼è¡¨ç¤º<strong>å¤§å¯¹è±¡</strong>ï¼Œå³ <code>&gt;32KB</code>ï¼Œè¿™ç§å¯¹è±¡åªä¼šåˆ†é…åˆ°<code>heap</code>ä¸Šï¼Œæ‰€ä»¥ä¸å¯èƒ½å‡ºç°åœ¨ <code>mcache.alloc</code> ä¸­ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">mspan</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">_</span>    <span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">NotInHeap</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// å‰åèŠ‚ç‚¹ ,åŒå‘é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">next</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mspan</span>    
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">prev</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mspan</span>   
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">startAddr</span> <span style="color:#66d9ef">uintptr</span>   
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">npages</span>    <span style="color:#66d9ef">uintptr</span> <span style="color:#75715e">// number of pages in span  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Object n starts at address n*elemsize + (start &lt;&lt; pageShift).  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">freeindex</span> <span style="color:#66d9ef">uintptr</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æœ€å¤šå¯ä»¥å­˜æ”¾å¤šå°‘span
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nelems</span> <span style="color:#66d9ef">uintptr</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// æ ‡è¯† mspan ç­‰çº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">spanclass</span> <span style="color:#a6e22e">spanClass</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// æ ‡è®°spanä¸­çš„elemå“ªäº›æ˜¯â€œè¢«ä½¿ç”¨â€çš„ï¼Œå“ªäº›æ˜¯æœªè¢«ä½¿ç”¨çš„ï¼›æ¸…é™¤åå°†é‡Šæ”¾ `allocBits` ï¼Œå¹¶å°† `allocBits` çš„å€¼è®¾ç½®ä¸º `gcmarkBits` 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">allocBits</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">gcBits</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gcmarkBits</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gcBits</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="mcentral-ä¸­å¿ƒç¼“å­˜">
    <strong>mcentral</strong> ï¼ˆä¸­å¿ƒç¼“å­˜ï¼‰<a class="hash-link" href="#mcentral-%e4%b8%ad%e5%bf%83%e7%bc%93%e5%ad%98" title="Direct link to heading">#</a>
</h3><blockquote>
<p>å½“ç”³è¯·ä¸€ä¸ª <code>16b</code> å¤§å°çš„å†…å­˜æ—¶ï¼Œå¦‚æœ <code>mcache</code> ä¸­æ— å¯ç”¨å¤§å°å†…å­˜æ—¶ï¼Œåˆ™å®ƒæ‰¾ä¸€ä¸ªæœ€åˆé€‚çš„è§„åˆ™ <code>mcentral</code> æŸ¥æ‰¾</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">mcentral</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">_</span>         <span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">NotInHeap</span>  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">spanclass</span> <span style="color:#a6e22e">spanClass</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// one of swept in-use spans, and one of unswept in-use span åœ¨æ¯è½®GCæœŸé—´éƒ½æ‰®æ¼”ç€ä¸åŒçš„è§’è‰²ã€‚`mheap_.sweepgen` åœ¨æ¯è½®gcæœŸé—´éƒ½ä¼šé€’å¢2ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">partial</span> [<span style="color:#ae81ff">2</span>]<span style="color:#a6e22e">spanSet</span> <span style="color:#75715e">// list of spans with a free object  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">full</span>    [<span style="color:#ae81ff">2</span>]<span style="color:#a6e22e">spanSet</span> <span style="color:#75715e">// list of spans with no free objects  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ol>
<li>mcentralä¹Ÿæ˜¯å­˜æ”¾åœ¨å…¨å±€å˜é‡mheapä¸­mheap_.central å¹¶ä¸”åœ¨64ä½linuxä¸‹æœ‰136 ä¸ª = 68 * 2ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªè§„æ ¼(spanclass)çš„mcentraléƒ½å­˜åœ¨ä¸¤ä»½ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨äº†å­˜æ”¾éœ€è¦æ‰«æçš„å¯¹è±¡ï¼ˆscan spanClassï¼‰ï¼Œå¦ä¸€ä¸ªå­˜æ”¾æ²¡æœ‰æŒ‡é’ˆçš„ä¸éœ€è¦æ‰«æçš„å¯¹è±¡ï¼ˆnoscan spanClassï¼‰</li>
<li>æ¯ä¸ª mcentral å¯¹åº”ä¸€ç§ spanClass</li>
<li>æ¯ä¸ª mcentral ä¸‹èšåˆäº†è¯¥ spanClass ä¸‹çš„ mspan</li>
<li>mcentral ä¸‹çš„ mspan åˆ†ä¸ºä¸¤ä¸ªé“¾è¡¨ï¼Œåˆ†åˆ«ä¸ºæœ‰ç©ºé—´ mspan é“¾è¡¨ partial å’Œæ»¡ç©ºé—´ mspan é“¾è¡¨ full</li>
<li>mcentralä¸æ˜¯å†…å­˜ï¼Œåªæ˜¯ä¸€ä¸ªç´¢å¼•ï¼ˆç›®å½•ï¼‰</li>
</ol>
<h3 id="mheap-é¡µå †">
    <strong>mheap</strong> ï¼ˆé¡µå †ï¼‰<a class="hash-link" href="#mheap-%e9%a1%b5%e5%a0%86" title="Direct link to heading">#</a>
</h3><blockquote>
<p>mheap.goæ–‡ä»¶æ˜¯Goè¯­è¨€è¿è¡Œæ—¶åŒ…ä¸­ï¼ˆruntimeï¼‰çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œä½œç”¨æ˜¯å®ç°Goè¯­è¨€çš„å †å†…å­˜ç®¡ç†ã€‚å…¶ä¸­å®šä¹‰äº†mheapç»“æ„ä½“å’Œç›¸å…³çš„æ–¹æ³•ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­è·Ÿè¸ªã€åˆ†é…å’Œé‡Šæ”¾å †å†…å­˜ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">mheap</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">NotInHeap</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// `lock` å…¨å±€é”ï¼Œä¿è¯å¹¶å‘ï¼Œæ‰€ä»¥å°½é‡é¿å…ä»`mheap`ä¸­åˆ†é…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">mutex</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">pages</span> <span style="color:#a6e22e">pageAlloc</span> <span style="color:#75715e">// page allocation data structure  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">sweepgen</span> <span style="color:#66d9ef">uint32</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// `allspans` æ‰€æœ‰çš„ spans éƒ½æ˜¯é€šè¿‡ `mheap_` ç”³è¯·ï¼Œæ‰€æœ‰ç”³è¯·è¿‡çš„ `mspan` éƒ½ä¼šè®°å½•åœ¨ `allspans`ï¼Œå¯ä»¥éšç€å †çš„å¢é•¿é‡æ–°åˆ†é…å’Œç§»åŠ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">allspans</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">mspan</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// å †arena æ˜ å°„ã€‚å®ƒæŒ‡å‘æ•´ä¸ªå¯ç”¨è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ¯ä¸ª arena å¸§çš„å †å…ƒæ•°æ®,ç”±ä¸€ä¸ªL1çº§æ˜ å°„å’Œå¤šä¸ªL2çº§æ˜ å°„ç»„æˆ, å½“æœ‰å¤§é‡çš„çš„ arena å¸§æ—¶å°†èŠ‚çœç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">arenas</span> [<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">arenaL1Bits</span>]<span style="color:#f92672">*</span>[<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">arenaL2Bits</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">heapArena</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">allArenas</span> []<span style="color:#a6e22e">arenaIdx</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">sweepArenas</span> []<span style="color:#a6e22e">arenaIdx</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">markArenas</span> []<span style="color:#a6e22e">arenaIdx</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// æ¯ç§è§„æ ¼å¤§å°çš„å—å¯¹åº”ä¸€ä¸ª mcentralã€‚pad æ˜¯ä¸€ä¸ªå­—èŠ‚å¡«å……ï¼Œç”¨æ¥é¿å…ä¼ªå…±äº«ï¼ˆfalse sharingï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">central</span> [<span style="color:#a6e22e">numSpanClasses</span>]<span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>	   <span style="color:#a6e22e">mcentral</span> <span style="color:#a6e22e">mcentral</span>  
</span></span><span style="display:flex;"><span>	   <span style="color:#a6e22e">pad</span>      [(<span style="color:#a6e22e">cpu</span>.<span style="color:#a6e22e">CacheLinePadSize</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">mcentral</span>{})<span style="color:#f92672">%</span><span style="color:#a6e22e">cpu</span>.<span style="color:#a6e22e">CacheLinePadSize</span>) <span style="color:#f92672">%</span> <span style="color:#a6e22e">cpu</span>.<span style="color:#a6e22e">CacheLinePadSize</span>]<span style="color:#66d9ef">byte</span>  
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>	
</span></span></code></pre></div><ol>
<li>mheapç»“æ„ä½“æ˜¯Goè¯­è¨€å †å†…å­˜ç®¡ç†æ ¸å¿ƒ
<ul>
<li>arenas</li>
<li>central</li>
</ul>
</li>
<li>mheapåœ¨golangæºç ä¸­æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€å˜é‡ï¼Œä½ç½®<code>$GOROOT/src/runtime/mheap.go/mheap_</code>  ï¼Œå…¶åŠ è½½é¡ºåºåœ¨ schedinit-&gt;mallocinit-&gt;mheap_.init()</li>
<li>Goä¸­å…¶è¢«ä½œä¸ºå…¨å±€å˜é‡<code>mheap_</code>å­˜å‚¨<code>var mheap_ mheap</code></li>
</ol>
<h4 id="heaparea">
    heapArea<a class="hash-link" href="#heaparea" title="Direct link to heading">#</a>
</h4><ol>
<li>heapArenaæ ‡è®°ä¸º<code>notinheap</code>ï¼Œè¡¨ç¤ºå¯¹è±¡è‡ªèº«å­˜å‚¨åœ¨Go heapä¹‹å¤–ã€‚å…¶é€šè¿‡mheap_.arenas index æ¥è®¿é—®ï¼ŒheapArenaå¯¹è±¡ä¹Ÿç›´æ¥ä»æ“ä½œç³»ç»Ÿåˆ†é…çš„</li>
<li>æ¯ä¸ª heapArena åŒ…å« 8192 ä¸ªé¡µï¼Œå¤§å°ä¸º 8192 * 8KB = 64 MB</li>
<li>heapArena è®°å½•äº†<strong>é¡µåˆ° mspan çš„æ˜ å°„</strong>. GC æ—¶ï¼Œé€šè¿‡åœ°å€åç§»æ‰¾åˆ°é¡µå¾ˆæ–¹ä¾¿ï¼Œä½†æ‰¾åˆ°å…¶æ‰€å±çš„ mspan ä¸å®¹æ˜“. å› æ­¤éœ€è¦é€šè¿‡è¿™ä¸ªæ˜ å°„ä¿¡æ¯è¿›è¡Œè¾…åŠ©.</li>
<li>heapArena æ˜¯ mheap å‘è™šæ‹Ÿå†…å­˜ç”³è¯·å†…å­˜çš„å•ä½</li>
<li>æ‰€æœ‰çš„heapArenaç»„æˆäº†mheapï¼ˆGoçš„å †å†…å­˜ï¼‰</li>
</ol>
<h2 id="å†…å­˜åˆ†é…">
    å†…å­˜åˆ†é…<a class="hash-link" href="#%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d" title="Direct link to heading">#</a>
</h2><blockquote>
<p><strong>Goè¯­è¨€ä¸­é‡‡ç”¨äº†åˆ†çº§åˆ†é…çš„ç­–ç•¥</strong>ã€‚å°†ä¸€ä¸ªheapArenaä¸­åˆ’åˆ†æˆè®¸å¤šå¤§å°ç›¸ç­‰çš„å°æ ¼å­ï¼Œç©ºé—´å¤§å°ç›¸åŒçš„æ ¼å­åˆ’åˆ†ä¸ºä¸€ä¸ªç­‰çº§ã€‚æœ€ç»ˆéƒ½ä¼šè°ƒç”¨mallocgcæ–¹æ³•ï¼Œnew(T)ï¼Œ&amp;T{}ï¼Œmake(xxxx)</p>
</blockquote>
<ol>
<li>å †ä¸Šæ‰€æœ‰çš„å¯¹è±¡å†…å­˜åˆ†é…éƒ½ä¼šé€šè¿‡<code>runtime.newobject</code>è¿›è¡Œåˆ†é…ï¼Œè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡å¤§å°å°†å®ƒä»¬åˆ†ä¸ºå¾®å¯¹è±¡ã€å°å¯¹è±¡å’Œå¤§å¯¹è±¡ï¼š
<ul>
<li><strong>tinyå¾®å¯¹è±¡ï¼ˆ0, 16Bï¼‰</strong>ï¼šå…ˆä½¿ç”¨å¾®å‹åˆ†é…å™¨ï¼Œå†ä¾æ¬¡å°è¯•çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œå †åˆ†é…å†…å­˜ï¼›å¤šä¸ªå°äº16Bçš„æ— æŒ‡é’ˆå¾®å¯¹è±¡çš„å†…å­˜åˆ†é…è¯·æ±‚ï¼Œä¼šåˆå¹¶å‘Tinyå¾®å¯¹è±¡ç©ºé—´ç”³è¯·ï¼Œå¾®å¯¹è±¡çš„ 16B å†…å­˜ç©ºé—´ä» spanClass ä¸º 4 æˆ– 5ï¼ˆæ— GCæ‰«æï¼‰çš„mspanä¸­è·å–ã€‚</li>
<li><strong>smallå°å¯¹è±¡[16B, 32KB]</strong>ï¼šå…ˆå‘mcacheç”³è¯·ï¼Œmcacheå†…å­˜ç©ºé—´ä¸å¤Ÿæ—¶ï¼Œå‘mcentralç”³è¯·ï¼Œmcentralä¸å¤Ÿï¼Œåˆ™å‘é¡µå †mheapç”³è¯·ï¼Œå†ä¸å¤Ÿå°±å‘æ“ä½œç³»ç»Ÿç”³è¯·ã€‚</li>
<li><strong>largeå¤§å¯¹è±¡(32KB, +âˆ)</strong>ï¼šå¤§å¯¹è±¡ç›´æ¥å‘é¡µå †mheapç”³è¯·ã€‚</li>
</ul>
</li>
<li>å¯¹äºå†…å­˜çš„é‡Šæ”¾ï¼Œéµå¾ªé€çº§é‡Šæ”¾çš„ç­–ç•¥ã€‚å½“ThreadCacheçš„ç¼“å­˜å……è¶³æˆ–è€…è¿‡å¤šæ—¶ï¼Œåˆ™ä¼šå°†å†…å­˜é€€è¿˜ç»™CentralCacheã€‚å½“CentralCacheå†…å­˜è¿‡å¤šæˆ–è€…å……è¶³ï¼Œåˆ™å°†ä½å‘½ä¸­å†…å­˜å—é€€è¿˜PageHeapã€‚</li>
</ol>
<h3 id="mallocgc">
    mallocgc<a class="hash-link" href="#mallocgc" title="Direct link to heading">#</a>
</h3><ol>
<li>å¯¹äºå¾®å¯¹è±¡çš„åˆ†é…æµç¨‹ï¼š
ï¼ˆ1ï¼‰ä» P ä¸“å± mcache çš„ tiny åˆ†é…å™¨å–å†…å­˜ï¼ˆæ— é”ï¼‰
ï¼ˆ2ï¼‰nextFreeFast æ ¹æ®æ‰€å±çš„ spanClassï¼Œä» P ä¸“å± mcache ç¼“å­˜çš„ mspan ä¸­å–å†…å­˜ï¼ˆæ— é”ï¼‰
ï¼ˆ3ï¼‰ æ ¹æ®æ‰€å±çš„ spanClass ä»å¯¹åº”çš„ mcentral ä¸­å– mspan å¡«å……åˆ° mcacheï¼Œç„¶åä» mspan ä¸­å–å†…å­˜ï¼ˆspanClass ç²’åº¦é”ï¼‰
ï¼ˆ4ï¼‰æ ¹æ®æ‰€å±çš„ spanClassï¼Œä» mheap çš„é¡µåˆ†é…å™¨ pageAlloc å–å¾—è¶³å¤Ÿæ•°é‡ç©ºé—²é¡µç»„è£…æˆ mspan å¡«å……åˆ° mcacheï¼Œç„¶åä» mspan ä¸­å–å†…å­˜ï¼ˆå…¨å±€é”ï¼‰
ï¼ˆ5ï¼‰mheap å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œæ›´æ–°é¡µåˆ†é…å™¨çš„ç´¢å¼•ä¿¡æ¯ï¼Œç„¶åé‡å¤ï¼ˆ4ï¼‰.</li>
<li>å¯¹äºå°å¯¹è±¡çš„åˆ†é…æµç¨‹æ˜¯è·³è¿‡ï¼ˆ1ï¼‰æ­¥ï¼Œæ‰§è¡Œä¸Šè¿°æµç¨‹çš„ï¼ˆ2ï¼‰-ï¼ˆ5ï¼‰æ­¥ï¼›</li>
<li>å¯¹äºå¤§å¯¹è±¡çš„åˆ†é…æµç¨‹æ˜¯è·³è¿‡ï¼ˆ1ï¼‰-ï¼ˆ3ï¼‰æ­¥ï¼Œæ‰§è¡Œä¸Šè¿°æµç¨‹çš„ï¼ˆ4ï¼‰-ï¼ˆ5ï¼‰æ­¥.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">size</span> <span style="color:#66d9ef">uintptr</span>, <span style="color:#a6e22e">typ</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span>, <span style="color:#a6e22e">needzero</span> <span style="color:#66d9ef">bool</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">assistG</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">deductAssistCredit</span>(<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è·å–m
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">acquirem</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ... è·å–mcache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getMCache</span>(<span style="color:#a6e22e">mp</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ... mspan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">span</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ˜¯å¦ä¸ºå°å¯¹è±¡ 32kb
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">maxSmallSize</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å°äº 16 B ä¸”æ— æŒ‡é’ˆï¼Œåˆ™è§†ä¸ºtinyå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">noscan</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">size</span> &lt; <span style="color:#a6e22e">maxTinySize</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 1. åˆ†é…tinyå¯¹è±¡å¦‚ä¸‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 2. åˆ†é…å°å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 3. åˆ†é…å¤§å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="tinyå¯¹è±¡åˆ†é…">
    tinyå¯¹è±¡åˆ†é…<a class="hash-link" href="#tiny%e5%af%b9%e8%b1%a1%e5%88%86%e9%85%8d" title="Direct link to heading">#</a>
</h3><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#a6e22e">noscan</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">typ</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">typ</span>.<span style="color:#a6e22e">ptrdata</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...        
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">noscan</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">size</span> &lt; <span style="color:#a6e22e">maxTinySize</span> {        
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// tiny å†…å­˜å—ä¸­ï¼Œä» offset å¾€åæœ‰ç©ºé—²ä½ç½®          
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">off</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">tinyoffset</span>          
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ...   è°ƒæ•´offå‚æ•°å¹¶å¯¹é½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// å¦‚æœå½“å‰ tiny å†…å­˜å—ç©ºé—´è¿˜å¤Ÿç”¨ï¼Œåˆ™ç›´æ¥åˆ†é…å¹¶è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">off</span><span style="color:#f92672">+</span><span style="color:#a6e22e">size</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">maxTinySize</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">tiny</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>	      <span style="color:#75715e">// åˆ†é…ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	      <span style="color:#a6e22e">x</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">tiny</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">off</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">tinyoffset</span> = <span style="color:#a6e22e">off</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">size</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">tinyAllocs</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mallocing</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">releasem</span>(<span style="color:#a6e22e">mp</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span>
</span></span><span style="display:flex;"><span>	  }
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// åˆ†é…ä¸€ä¸ªæ–°çš„tinyå†…å­˜å—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">span</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">alloc</span>[<span style="color:#a6e22e">tinySpanClass</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ä» mcache çš„ span ä¸­å°è¯•è·å–ç©ºé—´   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nextFreeFast</span>(<span style="color:#a6e22e">span</span>)  
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {  
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// é€šè¿‡mcentral,mheapå…œåº•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// åŒæ ·æ˜¯è·å–mcacheä¸­çš„ç¼“å­˜,ä½†æ˜¯æ›´åŠ è€—æ—¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// å¦‚æœmcacheä¸­æ²¡è·å–åˆ°åˆ™è·å–mcentralä¸­çš„mspanç”¨äºåˆ†é…(è°ƒç”¨refillæ–¹æ³•)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// å¦‚æœmcentralä¹Ÿæ²¡æœ‰åˆ™å»æ‰¾mheap.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// è¿™é‡Œçš„tinySpanClass,æ˜¯åºå·ä¸º2çš„spanClass,å³å¤§å°ä¸º16å­—èŠ‚.åŒæ—¶ä¹Ÿç­‰äºmacTinySize
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		   <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">span</span>, <span style="color:#a6e22e">shouldhelpgc</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">nextFree</span>(<span style="color:#a6e22e">tinySpanClass</span>)  
</span></span><span style="display:flex;"><span>		}  
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">size</span> = <span style="color:#a6e22e">maxTinySize</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span></code></pre></div><h4 id="newfreefast">
    newFreeFast<a class="hash-link" href="#newfreefast" title="Direct link to heading">#</a>
</h4><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">nextFreeFast</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mspan</span>) <span style="color:#a6e22e">gclinkptr</span> {  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">theBit</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">TrailingZeros64</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">allocCache</span>) <span style="color:#75715e">// åœ¨ bit map ä¸Šå¯»æ‰¾åˆ°é¦–ä¸ª object ç©ºä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">theBit</span> &lt; <span style="color:#ae81ff">64</span> {  
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">freeindex</span> <span style="color:#f92672">+</span> uintptr(<span style="color:#a6e22e">theBit</span>)  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">result</span> &lt; <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">nelems</span> {  
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">freeidx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">freeidx</span><span style="color:#f92672">%</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">freeidx</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">nelems</span> {  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>  
</span></span><span style="display:flex;"><span>         }  
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">allocCache</span> <span style="color:#f92672">&gt;&gt;=</span> uint(<span style="color:#a6e22e">theBit</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)  
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// åç§»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>         <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">freeindex</span> = <span style="color:#a6e22e">freeidx</span>  
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">allocCount</span><span style="color:#f92672">++</span>  
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// è¿”å›è·å–object ç©ºä½çš„å†…å­˜åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>         <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gclinkptr</span>(<span style="color:#a6e22e">result</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">elemsize</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">base</span>())  
</span></span><span style="display:flex;"><span>      }  
</span></span><span style="display:flex;"><span>   }  
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="nextfree">
    nextFree<a class="hash-link" href="#nextfree" title="Direct link to heading">#</a>
</h4><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mcache</span>) <span style="color:#a6e22e">nextFree</span>(<span style="color:#a6e22e">spc</span> <span style="color:#a6e22e">spanClass</span>) (<span style="color:#a6e22e">v</span> <span style="color:#a6e22e">gclinkptr</span>, <span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mspan</span>, <span style="color:#a6e22e">shouldhelpgc</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">alloc</span>[<span style="color:#a6e22e">spc</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ä» mcache çš„ span ä¸­è·å– object ç©ºä½çš„åç§»é‡    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">freeIndex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">nextFreeIndex</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">freeIndex</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">nelems</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...        
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// å€˜è‹¥ mcache ä¸­ span å·²ç»æ²¡æœ‰ç©ºä½ï¼Œåˆ™è°ƒç”¨ refill æ–¹æ³•ä» mcentral æˆ–è€… mheap ä¸­è·å–æ–°çš„ span            
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">refill</span>(<span style="color:#a6e22e">spc</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...        
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// å†æ¬¡ä»æ›¿æ¢åçš„ span ä¸­è·å– object ç©ºä½çš„åç§»é‡        
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">alloc</span>[<span style="color:#a6e22e">spc</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">freeIndex</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">nextFreeIndex</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">v</span> = <span style="color:#a6e22e">gclinkptr</span>(<span style="color:#a6e22e">freeIndex</span><span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">elemsize</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">base</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">allocCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="smallå¯¹è±¡åˆ†é…">
    smallå¯¹è±¡åˆ†é…<a class="hash-link" href="#small%e5%af%b9%e8%b1%a1%e5%88%86%e9%85%8d" title="Direct link to heading">#</a>
</h3><ol>
<li>æ ¹æ®å¯¹è±¡å¤§å°ï¼Œå‘ä¸Šè®¡ç®—æ‰€éœ€æœ€å°spanClass</li>
<li>é¦–å…ˆä»pçš„mcacheä¸­å–å¯¹åº”spanClassçš„spané“¾è¡¨ï¼Œå¦‚æœæœ‰ç©ºé—²çš„å†…å­˜å•å…ƒï¼Œåˆ™è¿”å›(nextFreeFast)</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œåˆ™å‘mcentralç”³è¯·ï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆ™å‘mheapç”³è¯·ã€‚(nextFreeFast)</li>
<li>æœ€åæ¸…ç†ç©ºé—²å†…å­˜</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#75715e">// è·å–spanclassä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sizeclass</span> <span style="color:#66d9ef">uint8</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">smallSizeMax</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span> {  
</span></span><span style="display:flex;"><span>	   <span style="color:#a6e22e">sizeclass</span> = <span style="color:#a6e22e">size_to_class8</span>[<span style="color:#a6e22e">divRoundUp</span>(<span style="color:#a6e22e">size</span>, <span style="color:#a6e22e">smallSizeDiv</span>)]  
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {  
</span></span><span style="display:flex;"><span>	   <span style="color:#a6e22e">sizeclass</span> = <span style="color:#a6e22e">size_to_class128</span>[<span style="color:#a6e22e">divRoundUp</span>(<span style="color:#a6e22e">size</span><span style="color:#f92672">-</span><span style="color:#a6e22e">smallSizeMax</span>, <span style="color:#a6e22e">largeSizeDiv</span>)]  
</span></span><span style="display:flex;"><span>	}  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ ¹æ®å¯¹åº”çš„spanclassï¼Œåˆ†é…ç»™æ¯ä¸ªå¯¹è±¡çš„ç©ºé—´å¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">size</span> = uintptr(<span style="color:#a6e22e">class_to_size</span>[<span style="color:#a6e22e">sizeclass</span>])  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">spc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">makeSpanClass</span>(<span style="color:#a6e22e">sizeclass</span>, <span style="color:#a6e22e">noscan</span>)  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">span</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">alloc</span>[<span style="color:#a6e22e">spc</span>]  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nextFreeFast</span>(<span style="color:#a6e22e">span</span>)  
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {  
</span></span><span style="display:flex;"><span>	   <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">span</span>, <span style="color:#a6e22e">shouldhelpgc</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">spc</span>)  
</span></span><span style="display:flex;"><span>	}  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">x</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">v</span>)  
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">needzero</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">needzero</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {  
</span></span><span style="display:flex;"><span>	   <span style="color:#a6e22e">memclrNoHeapPointers</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">size</span>)  
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><h3 id="largeå¯¹è±¡åˆ†é…">
    largeå¯¹è±¡åˆ†é…<a class="hash-link" href="#large%e5%af%b9%e8%b1%a1%e5%88%86%e9%85%8d" title="Direct link to heading">#</a>
</h3><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#a6e22e">shouldhelpgc</span> = <span style="color:#66d9ef">true</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç›´æ¥è°ƒç”¨mheapè¿›è¡Œåˆ†é…. makeSpanClass(0, noscan)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">span</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">allocLarge</span>(<span style="color:#a6e22e">size</span>, <span style="color:#a6e22e">noscan</span>)  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">freeindex</span> = <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">allocCount</span> = <span style="color:#ae81ff">1</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">size</span> = <span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">elemsize</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">x</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">base</span>())
</span></span></code></pre></div><h2 id="å‚è€ƒ">
    å‚è€ƒ<a class="hash-link" href="#%e5%8f%82%e8%80%83" title="Direct link to heading">#</a>
</h2><ol>
<li><a href="https://blog.csdn.net/qq_25490573/article/details/130027162">https://blog.csdn.net/qq_25490573/article/details/130027162</a></li>
<li><a href="https://cloud.tencent.com/developer/article/2077196">https://cloud.tencent.com/developer/article/2077196</a></li>
<li><a href="http://www.guoxiaolong.cn/blog/?id=12004">http://www.guoxiaolong.cn/blog/?id=12004</a></li>
<li><a href="https://blog.haohtml.com/archives/29385#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">https://blog.haohtml.com/archives/29385#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99</a></li>
<li><a href="https://mp.weixin.qq.com/s/2TBwpQT5-zU4Gy7-i0LZmQ">https://mp.weixin.qq.com/s/2TBwpQT5-zU4Gy7-i0LZmQ</a></li>
</ol>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/go/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Go</a>
   </li>
  
   <li class="list di">
     <a href="/tags/memory/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Memory</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      <script src="https://utteranc.es/client.js" repo="ZhongsJie96/ZhongsJie96.github.io" issue-term="pathname"
        label="Comment" theme="github-light" crossorigin="anonymous" async>
        </script>
    </div>
  </div>

  <aside class="w-30-l mt6-l">




</aside>

</article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
    <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://blogs.atomage.cn">
      &copy;  Atomage's Blog  2022-2023 
    </a>
    <div>
<div class="ananke-socials">
  
    
    <a href="https://github.com/ZhongsJie96" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHubâ€”â€”Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
    <a href="https://beian.miit.gov.cn/" class="link db f6 pa2 br3 bg-mid-gray white dim w4 tc"> èœ€ICPå¤‡2022025742å· </a>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HVT9CMYGB1"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-HVT9CMYGB1', { 'anonymize_ip': false });
}
</script>

  </div>
</footer>

  </body>
</html>
