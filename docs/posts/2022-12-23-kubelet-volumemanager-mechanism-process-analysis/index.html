<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ | Atomage&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ# Kubelet Volumeç›¸å…³é€»è¾‘ä¸»è¦åœ¨VolumeManageræ¨¡å— Mount é˜¶æ®µåˆ™ç”±å¯¹åº”èŠ‚ç‚¹çš„ kubelet ä¸­çš„ volume manager å¤„ç†ã€‚ volume manager è·å– node.Status.VolumesAttached å±æ€§å€¼ï¼Œå‘ç° volume å·²è¢«æ ‡è®°ä¸º attached, å°±ä¼šè¿›è¡Œ mount æ“ä½œ k8sä¸­æ¶‰åŠå­˜å‚¨çš„ç»„ä»¶ä¸»è¦æœ‰ï¼šattach/detach controllerã€pv controllerã€volume managerã€volume pluginsã€schedulerã€‚æ¯ä¸ªç»„ä»¶åˆ†å·¥æ˜ç¡®ï¼š attach/detach controllerï¼šè´Ÿè´£å¯¹ volume è¿›è¡Œ attach/detach persistent volume controllerï¼šè´Ÿè´£å¤„ç† pv/pvc å¯¹è±¡ï¼ŒåŒ…æ‹¬ pv çš„ provision/delete kubelet volume managerï¼šä¸»è¦è´Ÿè´£å¯¹ volume è¿›è¡Œ mount/unmount volume pluginsï¼šåŒ…å« k8s åŸç”Ÿçš„å’Œå„å‚å•†çš„çš„å­˜å‚¨æ’ä»¶ æŒ‚è½½æµç¨‹# ç¬¬ä¸€æ­¥æ˜¯åœ¨å‡†å¤‡ volumeï¼ˆ">
    <meta name="generator" content="Hugo 0.115.2">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ" />
<meta property="og:description" content="Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ# Kubelet Volumeç›¸å…³é€»è¾‘ä¸»è¦åœ¨VolumeManageræ¨¡å— Mount é˜¶æ®µåˆ™ç”±å¯¹åº”èŠ‚ç‚¹çš„ kubelet ä¸­çš„ volume manager å¤„ç†ã€‚ volume manager è·å– node.Status.VolumesAttached å±æ€§å€¼ï¼Œå‘ç° volume å·²è¢«æ ‡è®°ä¸º attached, å°±ä¼šè¿›è¡Œ mount æ“ä½œ k8sä¸­æ¶‰åŠå­˜å‚¨çš„ç»„ä»¶ä¸»è¦æœ‰ï¼šattach/detach controllerã€pv controllerã€volume managerã€volume pluginsã€schedulerã€‚æ¯ä¸ªç»„ä»¶åˆ†å·¥æ˜ç¡®ï¼š attach/detach controllerï¼šè´Ÿè´£å¯¹ volume è¿›è¡Œ attach/detach persistent volume controllerï¼šè´Ÿè´£å¤„ç† pv/pvc å¯¹è±¡ï¼ŒåŒ…æ‹¬ pv çš„ provision/delete kubelet volume managerï¼šä¸»è¦è´Ÿè´£å¯¹ volume è¿›è¡Œ mount/unmount volume pluginsï¼šåŒ…å« k8s åŸç”Ÿçš„å’Œå„å‚å•†çš„çš„å­˜å‚¨æ’ä»¶ æŒ‚è½½æµç¨‹# ç¬¬ä¸€æ­¥æ˜¯åœ¨å‡†å¤‡ volumeï¼ˆ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blogs.atomage.cn/posts/2022-12-23-kubelet-volumemanager-mechanism-process-analysis/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-23T12:36:09+08:00" />
<meta property="article:modified_time" content="2022-12-23T12:36:09+08:00" />
<meta itemprop="name" content="Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ">
<meta itemprop="description" content="Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ# Kubelet Volumeç›¸å…³é€»è¾‘ä¸»è¦åœ¨VolumeManageræ¨¡å— Mount é˜¶æ®µåˆ™ç”±å¯¹åº”èŠ‚ç‚¹çš„ kubelet ä¸­çš„ volume manager å¤„ç†ã€‚ volume manager è·å– node.Status.VolumesAttached å±æ€§å€¼ï¼Œå‘ç° volume å·²è¢«æ ‡è®°ä¸º attached, å°±ä¼šè¿›è¡Œ mount æ“ä½œ k8sä¸­æ¶‰åŠå­˜å‚¨çš„ç»„ä»¶ä¸»è¦æœ‰ï¼šattach/detach controllerã€pv controllerã€volume managerã€volume pluginsã€schedulerã€‚æ¯ä¸ªç»„ä»¶åˆ†å·¥æ˜ç¡®ï¼š attach/detach controllerï¼šè´Ÿè´£å¯¹ volume è¿›è¡Œ attach/detach persistent volume controllerï¼šè´Ÿè´£å¤„ç† pv/pvc å¯¹è±¡ï¼ŒåŒ…æ‹¬ pv çš„ provision/delete kubelet volume managerï¼šä¸»è¦è´Ÿè´£å¯¹ volume è¿›è¡Œ mount/unmount volume pluginsï¼šåŒ…å« k8s åŸç”Ÿçš„å’Œå„å‚å•†çš„çš„å­˜å‚¨æ’ä»¶ æŒ‚è½½æµç¨‹# ç¬¬ä¸€æ­¥æ˜¯åœ¨å‡†å¤‡ volumeï¼ˆ"><meta itemprop="datePublished" content="2022-12-23T12:36:09+08:00" />
<meta itemprop="dateModified" content="2022-12-23T12:36:09+08:00" />
<meta itemprop="wordCount" content="2091">
<meta itemprop="keywords" content="Kubernetes,Kubelet,Volume," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ"/>
<meta name="twitter:description" content="Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ# Kubelet Volumeç›¸å…³é€»è¾‘ä¸»è¦åœ¨VolumeManageræ¨¡å— Mount é˜¶æ®µåˆ™ç”±å¯¹åº”èŠ‚ç‚¹çš„ kubelet ä¸­çš„ volume manager å¤„ç†ã€‚ volume manager è·å– node.Status.VolumesAttached å±æ€§å€¼ï¼Œå‘ç° volume å·²è¢«æ ‡è®°ä¸º attached, å°±ä¼šè¿›è¡Œ mount æ“ä½œ k8sä¸­æ¶‰åŠå­˜å‚¨çš„ç»„ä»¶ä¸»è¦æœ‰ï¼šattach/detach controllerã€pv controllerã€volume managerã€volume pluginsã€schedulerã€‚æ¯ä¸ªç»„ä»¶åˆ†å·¥æ˜ç¡®ï¼š attach/detach controllerï¼šè´Ÿè´£å¯¹ volume è¿›è¡Œ attach/detach persistent volume controllerï¼šè´Ÿè´£å¤„ç† pv/pvc å¯¹è±¡ï¼ŒåŒ…æ‹¬ pv çš„ provision/delete kubelet volume managerï¼šä¸»è¦è´Ÿè´£å¯¹ volume è¿›è¡Œ mount/unmount volume pluginsï¼šåŒ…å« k8s åŸç”Ÿçš„å’Œå„å‚å•†çš„çš„å­˜å‚¨æ’ä»¶ æŒ‚è½½æµç¨‹# ç¬¬ä¸€æ­¥æ˜¯åœ¨å‡†å¤‡ volumeï¼ˆ"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    



  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Atomage&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/archives/" title="â±ï¸Archives page">
              â±ï¸Archives
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="ğŸ“Posts page">
              ğŸ“Posts
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="ğŸ™‹ğŸ»â€â™‚ï¸About page">
              ğŸ™‹ğŸ»â€â™‚ï¸About
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    
    <a href="https://github.com/ZhongsJie96" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHubâ€”â€”Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      

<article class="flex-l flex-wrap justify-between mw8 center ph3">
  <header class="mt4 w-100">
    <aside class="instapaper_ignoref b helvetica tracked">
      
      ğŸ“POSTS
    </aside>
    










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


    <h1 class="f1 athelas mt3 mb1">Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ</h1>
    
    <p class="tracked">
      By <strong>
        
        ZhongsJie
        
      </strong>
    </p>
    
    
    <time class="f6 mv4 dib tracked" datetime="2022-12-23T12:36:09+08:00" >December 23, 2022</time>

    
    
    <span class="f6 mv4 dib tracked"> - 5 minutes read</span>
    <span class="f6 mv4 dib tracked"> - 2091 words</span>
    
  </header>
  <div class="nested-copy-line-height lh-copy serif f4 nested-links
    nested-img mid-gray pr4-l w-100-l"><h2 id="kubelet-volumemanageræœºåˆ¶æµç¨‹åˆ†æ">
    Kubelet VolumeManageræœºåˆ¶æµç¨‹åˆ†æ<a class="hash-link" href="#kubelet-volumemanager%e6%9c%ba%e5%88%b6%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90" title="Direct link to heading">#</a>
</h2><blockquote>
<p>Kubelet Volumeç›¸å…³é€»è¾‘ä¸»è¦åœ¨VolumeManageræ¨¡å—</p>
</blockquote>
<p><img src="/images/2022-12/image-volumemanager.png" alt="VolumeManager"></p>
<ol>
<li>Mount é˜¶æ®µåˆ™ç”±å¯¹åº”èŠ‚ç‚¹çš„ kubelet ä¸­çš„ volume manager å¤„ç†ã€‚</li>
<li>volume manager è·å– node.Status.VolumesAttached å±æ€§å€¼ï¼Œå‘ç° volume å·²è¢«æ ‡è®°ä¸º attached, å°±ä¼šè¿›è¡Œ mount æ“ä½œ</li>
<li>k8sä¸­æ¶‰åŠå­˜å‚¨çš„ç»„ä»¶ä¸»è¦æœ‰ï¼šattach/detach controllerã€pv controllerã€volume managerã€volume pluginsã€schedulerã€‚æ¯ä¸ªç»„ä»¶åˆ†å·¥æ˜ç¡®ï¼š
<ul>
<li><strong>attach/detach controller</strong>ï¼šè´Ÿè´£å¯¹ volume è¿›è¡Œ attach/detach</li>
<li><strong>persistent volume controller</strong>ï¼šè´Ÿè´£å¤„ç† pv/pvc å¯¹è±¡ï¼ŒåŒ…æ‹¬ pv çš„ provision/delete</li>
<li><strong>kubelet volume manage</strong>rï¼šä¸»è¦è´Ÿè´£å¯¹ volume è¿›è¡Œ mount/unmount</li>
<li><strong>volume plugins</strong>ï¼šåŒ…å« k8s åŸç”Ÿçš„å’Œå„å‚å•†çš„çš„å­˜å‚¨æ’ä»¶</li>
</ul>
</li>
</ol>
<h3 id="æŒ‚è½½æµç¨‹">
    æŒ‚è½½æµç¨‹<a class="hash-link" href="#%e6%8c%82%e8%bd%bd%e6%b5%81%e7%a8%8b" title="Direct link to heading">#</a>
</h3><blockquote>
<p>ç¬¬ä¸€æ­¥æ˜¯åœ¨å‡†å¤‡ volumeï¼ˆå®¿ä¸»æœºç›®å½•ï¼‰ï¼Œç¬¬äºŒæ­¥æ‰æ˜¯çœŸæ­£çš„æŒ‚è½½æ“ä½œã€‚</p>
</blockquote>
<ol>
<li>k8s ä¸­çš„Â <strong>Volume</strong>Â å±äº Pod å†…éƒ¨å…±äº«èµ„æºå­˜å‚¨ï¼Œç”Ÿå‘½å‘¨æœŸå’Œ Pod ç›¸åŒï¼Œä¸ Container æ— å…³ï¼Œå³ä½¿ Pod ä¸Šçš„å®¹å™¨åœæ­¢æˆ–è€…é‡å¯ï¼ŒVolume ä¸ä¼šå—åˆ°å½±å“ï¼Œä½†æ˜¯å¦‚æœ Pod ç»ˆæ­¢ï¼Œé‚£ä¹ˆè¿™ä¸ª Volume çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå°†ç»“æŸã€‚</li>
<li>æ•´ä¸ªæŒ‚è½½æµç¨‹éœ€è¦ kube-controller-managerã€ kubelet ä»¥åŠ cri å…±åŒå®Œæˆï¼Œä¸€ä¸ªå®Œæ•´çš„æµç¨‹å¤§è‡´å¯åˆ†ä¸ºä»¥ä¸‹ ä¸¤ä¸ªæ­¥éª¤ï¼š
<ul>
<li>1ï¼‰è¿œç¨‹å­˜å‚¨æŒ‚è½½è‡³å®¿ä¸»æœº
<ul>
<li>1ï¼‰Attach
<ul>
<li>ç”± controller æ‰§è¡Œï¼Œå°†è¿œç¨‹å—å­˜å‚¨ä½œä¸ºä¸€ä¸ªè¿œç¨‹ç£ç›˜æŒ‚è½½åˆ°å®¿ä¸»æœº</li>
</ul>
</li>
<li>2ï¼‰Mount
<ul>
<li>ç”± kubelet æ‰§è¡Œï¼Œå°†è¿œç¨‹ç£ç›˜æ ¼å¼åŒ–å¹¶æŒ‚è½½åˆ° Volume å¯¹åº”çš„å®¿ä¸»æœºç›®å½•</li>
<li>ä¸€èˆ¬æ˜¯åœ¨ /var/lib/kubelet ç›®å½•ä¸‹</li>
</ul>
</li>
</ul>
</li>
<li>2ï¼‰å°†å®¿ä¸»æœºç›®å½•æŒ‚è½½è‡³ Pod ä¸­
<ul>
<li>ç”± CRI æ‰§è¡Œï¼Œå°†å®¿ä¸»æœºä¸Šçš„ç›®å½•æŒ‚è½½åˆ° Pod ä¸­</li>
</ul>
</li>
</ul>
</li>
<li>NFS æœ¬èº«å°±æ˜¯æ–‡ä»¶ç³»ç»Ÿå°±å¯ä»¥çœç•¥ Attach</li>
</ol>
<h4 id="è¿œç¨‹å­˜å‚¨æŒ‚è½½è‡³å®¿ä¸»æœº">
    è¿œç¨‹å­˜å‚¨æŒ‚è½½è‡³å®¿ä¸»æœº<a class="hash-link" href="#%e8%bf%9c%e7%a8%8b%e5%ad%98%e5%82%a8%e6%8c%82%e8%bd%bd%e8%87%b3%e5%ae%bf%e4%b8%bb%e6%9c%ba" title="Direct link to heading">#</a>
</h4><blockquote>
<p>k8s çš„ api å°±æ˜¯åªæœ‰ä½¿ç”¨ PV çš„æ—¶å€™æ‰§è¡Œè¯¥æµç¨‹</p>
</blockquote>
<ol>
<li>åŸºç¡€é˜¶æ®µ
<ul>
<li>é˜¶æ®µä¸€ï¼šAttachï¼ŒæŒ‚è½½ç£ç›˜</li>
<li>é˜¶æ®µäºŒï¼šMountï¼Œæ ¼å¼åŒ–ç£ç›˜å¹¶ mount è‡³å®¿ä¸»æœºç›®å½•</li>
</ul>
</li>
<li>æœ€ç»ˆçš„å‡†å¤‡å¥½çš„volumeéƒ½ä¼šæ”¾åˆ°ä»¥ä¸‹ç›®å½•
<ul>
<li><code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code></li>
</ul>
</li>
</ol>
<h3 id="volumemanagerç›¸å…³ç»“æ„ä½“">
    volumeManagerç›¸å…³ç»“æ„ä½“<a class="hash-link" href="#volumemanager%e7%9b%b8%e5%85%b3%e7%bb%93%e6%9e%84%e4%bd%93" title="Direct link to heading">#</a>
</h3><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// volumeManager implements the VolumeManager interfacetype 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">volumeManager</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// kubeClient is the kube API client 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">kubeClient</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">Interface</span>  
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// å®ç°åˆå§‹åŒ–å¥½çš„æ’ä»¶ç®¡ç†å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">volumePluginMgr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">volume</span>.<span style="color:#a6e22e">VolumePluginMgr</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// åŒ…å«äº†vmæƒ³è¦è¾¾æˆçš„ä¸€ä¸ªçŠ¶æ€ï¼šé‚£äº›å·åº”è¯¥è¢«è¿æ¥ï¼Œé‚£ä¸ªpodsä¼šå¼•ç”¨è¿™äº›å·ã€‚ä» podManagerè·å–æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">desiredStateOfWorld</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">DesiredStateOfWorld</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// åŒ…å«äº†å®é™…çš„vmçŠ¶æ€ã€‚åœ¨Â  attach,Â  detach, mount, and unmountÂ  æ“ä½œçš„æ—¶å€™è®°å½•è¿™äº›ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">actualStateOfWorld</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ActualStateOfWorld</span>  
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// å¼‚æ­¥æ‰§è¡Œ attach, detach, mount,unmountæ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">operationExecutor</span> <span style="color:#a6e22e">operationexecutor</span>.<span style="color:#a6e22e">OperationExecutor</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// è¿è¡Œå¼‚æ­¥å®šæœŸå¾ªç¯ï¼Œé€šè¿‡ä½¿ç”¨operationExecutor æ¥åè°ƒdesiredStateOfWorldä¸actualStateOfWorld
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">reconciler</span> <span style="color:#a6e22e">reconciler</span>.<span style="color:#a6e22e">Reconciler</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Â è¿è¡Œå¼‚æ­¥å®šæœŸå¾ªç¯ï¼Œä½¿ç”¨ PodManager å¡«å…… desiredStateOfWorld 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">desiredStateOfWorldPopulator</span> <span style="color:#a6e22e">populator</span>.<span style="color:#a6e22e">DesiredStateOfWorldPopulator</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// csiMigratedPluginManager keeps track of CSI migration status of plugins   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">csiMigratedPluginManager</span> <span style="color:#a6e22e">csimigration</span>.<span style="color:#a6e22e">PluginManager</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// intreeToCSITranslator translates in-tree volume specs to CSI   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">intreeToCSITranslator</span> <span style="color:#a6e22e">csimigration</span>.<span style="color:#a6e22e">InTreeToCSITranslator</span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="actualstateofworld">
    actualStateOfWorld<a class="hash-link" href="#actualstateofworld" title="Direct link to heading">#</a>
</h4><blockquote>
<p>ä¿å­˜å½“å‰nodeçš„æ‰€æœ‰å®é™…æŒ‚è½½çŠ¶æ€</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">actualStateOfWorld</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">nodeName</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NodeName</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å­˜å‚¨æ‰€æœ‰å·æŒ‚è½½æƒ…å†µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">attachedVolumes</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">UniqueVolumeName</span>]<span style="color:#a6e22e">attachedVolume</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">-</span>&gt; <span style="color:#a6e22e">mountedPods</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">volumetypes</span>.<span style="color:#a6e22e">UniquePodName</span>]<span style="color:#a6e22e">mountedPod</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="desiredstateofworld">
    desiredStateOfWorld<a class="hash-link" href="#desiredstateofworld" title="Direct link to heading">#</a>
</h4><blockquote>
<p>æœŸæœ›æŒ‚è½½çŠ¶æ€</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">desiredStateOfWorld</span> <span style="color:#66d9ef">struct</span> {  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æœŸæœ›æŒ‚è½½çš„æƒ…å†µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">volumesToMount</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">UniqueVolumeName</span>]<span style="color:#a6e22e">volumeToMount</span>
</span></span><span style="display:flex;"><span>	   <span style="color:#f92672">-</span>&gt; <span style="color:#a6e22e">podsToMount</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">UniquePodName</span>]<span style="color:#a6e22e">podToMount</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="reconcile">
    reconcile<a class="hash-link" href="#reconcile" title="Direct link to heading">#</a>
</h3><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">reconciler</span>) <span style="color:#a6e22e">reconcile</span>() {  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Unmounts are triggered before mounts so that a volume that was  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// referenced by a pod that was deleted and is now referenced by another   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// pod is unmounted from the first pod before being mounted to the new  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// pod.   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// éå† node ä¸Šçš„ mountedVolumeï¼Œæ£€æŸ¥ pod è¿˜åœ¨ä¸åœ¨ï¼Œå¦‚æœ pod ä¸åœ¨äº†å°±æŠŠå¯¹åº” volume unmount
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">rc</span>.<span style="color:#a6e22e">unmountVolumes</span>()  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Next we mount required volumes. This function could also trigger  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// attach if kubelet is responsible for attaching volumes.   // If underlying PVC was resized while in-use then this function also handles volume   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// resizing.   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// éå†éœ€è¦ mount æˆ–è€… attach çš„ volumeï¼Œçœ‹ä¸‹æ˜¯ä¸æ˜¯çœŸçš„ mount æˆ–è€… attachäº†ï¼Œæ²¡æœ‰å°±æ‰§è¡Œ mount æˆ–è€… attach.è®¾å¤‡éœ€è¦å…ˆ attachï¼Œå› æ­¤ kubelet è¿™é‡Œä¼šä¸€ç›´é˜»å¡ï¼Œäº§ç”Ÿä¸€ä¸ªå«åš VolumeNotAttached çš„é”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">rc</span>.<span style="color:#a6e22e">mountOrAttachVolumes</span>()  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Ensure devices that should be detached/unmounted are detached/unmounted.  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// unmountDetachDevicesï¼šå¦‚æœæŸä¸ªè®¾å¤‡çš„å¤šä¸ª volume éƒ½æ˜¯ unmount çŠ¶æ€é‚£å°±æŠŠè¯¥è®¾å¤‡ detach æ‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">rc</span>.<span style="color:#a6e22e">unmountDetachDevices</span>()  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// After running the above operations if skippedDuringReconstruction is not empty  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// then ensure that all volumes which were discovered and skipped during reconstruction   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">// are added to actualStateOfWorld in uncertain state.   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">rc</span>.<span style="color:#a6e22e">skippedDuringReconstruction</span>) &gt; <span style="color:#ae81ff">0</span> {  
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rc</span>.<span style="color:#a6e22e">processReconstructedVolumes</span>()  
</span></span><span style="display:flex;"><span>   }  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="desiredstateofworldpopulator">
    desiredStateOfWorldPopulator<a class="hash-link" href="#desiredstateofworldpopulator" title="Direct link to heading">#</a>
</h3><blockquote>
<p>Â è¿è¡Œå¼‚æ­¥å®šæœŸå¾ªç¯ï¼Œä½¿ç”¨ PodManager å¡«å…… desiredStateOfWorld</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">PollUntil</span>(<span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">loopSleepDuration</span>, <span style="color:#66d9ef">func</span>() (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sourcesReady</span>.<span style="color:#a6e22e">AllReady</span>()  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">populatorLoop</span>()  
</span></span><span style="display:flex;"><span>	   <span style="color:#f92672">-</span>&gt; {
</span></span><span style="display:flex;"><span>			   <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">findAndAddNewPods</span>()
</span></span><span style="display:flex;"><span>			   <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">findAndRemoveDeletedPods</span>()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">done</span>, <span style="color:#66d9ef">nil</span>  
</span></span><span style="display:flex;"><span>}, <span style="color:#a6e22e">stopCh</span>)
</span></span></code></pre></div><h4 id="findandaddnewpods">
    findAndAddNewPods<a class="hash-link" href="#findandaddnewpods" title="Direct link to heading">#</a>
</h4><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dswp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">desiredStateOfWorldPopulator</span>) <span style="color:#a6e22e">findAndAddNewPods</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">podManager</span>.<span style="color:#a6e22e">GetPods</span>() {  
</span></span><span style="display:flex;"><span>	   <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	   <span style="color:#75715e">// å¡«å…… desiredStateOfWorld 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	   <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">processPodVolumes</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">mountedVolumesForPod</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//...  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">-</span>&gt; <span style="color:#a6e22e">uniqueVolumeName</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">desiredStateOfWorld</span>.<span style="color:#a6e22e">AddPodToVolume</span>(  
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">uniquePodName</span>, <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">volumeSpec</span>, <span style="color:#a6e22e">podVolume</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">volumeGidValue</span>, <span style="color:#a6e22e">seLinuxContainerContexts</span>[<span style="color:#a6e22e">podVolume</span>.<span style="color:#a6e22e">Name</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="findandremovedeletedpods">
    findAndRemoveDeletedPods<a class="hash-link" href="#findandremovedeletedpods" title="Direct link to heading">#</a>
</h4><blockquote>
<p>éå†æ‰€æœŸæœ›çŠ¶æ€ä¸‹çš„æ‰€æœ‰podï¼Œå¦‚æœinformerä¸­ä¸å†å­˜åœ¨ï¼Œåˆ™å°†å…¶ç§»é™¤</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dswp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">desiredStateOfWorldPopulator</span>) <span style="color:#a6e22e">findAndRemoveDeletedPods</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">podExists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">podManager</span>.<span style="color:#a6e22e">GetPodByUID</span>(<span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">Pod</span>.<span style="color:#a6e22e">UID</span>)  
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">podExists</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// åˆ¤æ–­podä¸­å®¹å™¨æ˜¯å¦éƒ½å·²ç»ç»ˆæ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">podStateProvider</span>.<span style="color:#a6e22e">ShouldPodRuntimeBeRemoved</span>(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">UID</span>) {  
</span></span><span style="display:flex;"><span>		   <span style="color:#66d9ef">continue</span>  
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ˜¯å¦ä¿æŒç»ˆæ­¢podçš„å·  nodeä¸Šæ³¨è§£KeepTerminatedPodVolumesAnnotation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">keepTerminatedPodVolumes</span> {  
</span></span><span style="display:flex;"><span>		   <span style="color:#66d9ef">continue</span>  
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">removed</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">actualStateOfWorld</span>.<span style="color:#a6e22e">PodRemovedFromVolume</span>(<span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">PodName</span>, <span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">VolumeName</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">removed</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">podExists</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åˆ é™¤æœŸæœ›çš„çŠ¶æ€ï¼Œä»¥åŠç›¸å…³è®°å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">desiredStateOfWorld</span>.<span style="color:#a6e22e">DeletePodFromVolume</span>(  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">PodName</span>, <span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">VolumeName</span>)  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dswp</span>.<span style="color:#a6e22e">deleteProcessedPod</span>(<span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">PodName</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="mountorattachvolumes">
    mountOrAttachVolumes<a class="hash-link" href="#mountorattachvolumes" title="Direct link to heading">#</a>
</h3><blockquote>
<p>Kubeletçš„VolumeæŒ‚è½½æµç¨‹ï¼Œè°ƒç”¨OperationExecutoræ‰§è¡ŒMountVolume</p>
</blockquote>
<h4 id="mountvolume">
    MountVolume<a class="hash-link" href="#mountvolume" title="Direct link to heading">#</a>
</h4><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">oe</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">operationExecutor</span>) <span style="color:#a6e22e">MountVolume</span>(<span style="color:#f92672">...</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">-</span>&gt; <span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">og</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">operationGenerator</span>) <span style="color:#a6e22e">GenerateDetachVolumeFunc</span>(<span style="color:#f92672">...</span>)(<span style="color:#f92672">...</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">volumePlugin</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span>  
</span></span><span style="display:flex;"><span>	   <span style="color:#a6e22e">og</span>.<span style="color:#a6e22e">volumePluginMgr</span>.<span style="color:#a6e22e">FindPluginBySpec</span>(<span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">VolumeSpec</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mountVolumeFunc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">volumetypes</span>.<span style="color:#a6e22e">OperationContext</span> {
</span></span><span style="display:flex;"><span>		   <span style="color:#75715e">// è·å–æŒ‚è½½å·æ’ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">volumePlugin</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">og</span>.<span style="color:#a6e22e">volumePluginMgr</span>.<span style="color:#a6e22e">FindPluginBySpec</span>(<span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">VolumeSpec</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// æ£€æŸ¥nodeäº²å’Œæ€§  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">affinityErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">checkNodeAffinity</span>(<span style="color:#a6e22e">og</span>, <span style="color:#a6e22e">volumeToMount</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// è·å–mounterï¼Œæ‰€æœ‰çš„æŒ‚è½½ç±»å‹éƒ½æ‹¥æœ‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">volumeMounter</span>, <span style="color:#a6e22e">newMounterErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">volumePlugin</span>.<span style="color:#a6e22e">NewMounter</span>(<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//è·å–attacherï¼Œæ‰€æœ‰çš„å·éƒ½éœ€è¦æŒ‚è½½ä»¥åŠæ¥è§¦æŒ‚è½½ï¼Œä½†æ˜¯ä¸æ˜¯æ‰€æœ‰çš„éƒ½éœ€è¦attacher  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">attachableVolumePlugin</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">og</span>.<span style="color:#a6e22e">volumePluginMgr</span>.<span style="color:#a6e22e">FindAttachablePluginBySpec</span>(<span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">VolumeSpec</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">deviceMountableVolumePlugin</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">og</span>.<span style="color:#a6e22e">volumePluginMgr</span>.<span style="color:#a6e22e">FindDeviceMountablePluginBySpec</span>(<span style="color:#a6e22e">volumeToMount</span>.<span style="color:#a6e22e">VolumeSpec</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// æ ¸å¿ƒ è®¾ç½®æŒ‚è½½æ–‡ä»¶ï¼ˆåˆ›å»ºè·¯å¾„å¹¶ä¸”å†™å…¥å†…å®¹ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">mountErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">volumeMounter</span>.<span style="color:#a6e22e">SetUp</span>(<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// setupå¤±è´¥åä¼šåˆ é™¤å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#f92672">-</span>&gt; <span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">configMapVolumeMounter</span>) <span style="color:#a6e22e">SetUpAt</span>(<span style="color:#a6e22e">dir</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">mounterArgs</span> <span style="color:#a6e22e">volume</span>.<span style="color:#a6e22e">MounterArgs</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// è·å–configmapèµ„æºï¼Œå¦‚æœä¸æ˜¯å¯é€‰é¡¹æ‰¾ä¸åˆ°çš„æ—¶å€™ä¼šæŠ¥configmap not founté”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">getConfigMap</span>(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// æ‹¼è£…payload  map[string]volumeutil.FileProjectionå¯¹è±¡ï¼ˆæ–‡ä»¶åå’Œæ–‡ä»¶æŠ•å½±ä¿¡æ¯ï¼‰,ä½†æ²¡æœ‰æŒ‡å®šmodeçš„æ—¶å€™é‡‡ç”¨é»˜è®¤æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#a6e22e">payload</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MakePayload</span>(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">Items</span>, <span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">source</span>.<span style="color:#a6e22e">DefaultMode</span>, <span style="color:#a6e22e">optional</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// åˆ›å»ºæŒ‚è½½ç‚¹ï¼Œè·å–å½“å‰å·çš„æ‰€æœ‰æŒ‚è½½è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#75715e">// 1. ä¸èƒ½å†rootfsä¹‹å¤–åˆ›å»ºç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#75715e">// 2. æ£€æŸ¥æ¯ä¸ªè£…è½½ç‚¹ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦åµŒå¥—åœ¨è¿™ä¸ªå·ä¸‹é¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#a6e22e">volumeutil</span>.<span style="color:#a6e22e">MakeNestedMountpoints</span>(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">volName</span>, <span style="color:#a6e22e">dir</span>, <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">pod</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul class="pa0">
  
   <li class="list di">
     <a href="/tags/kubernetes/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Kubernetes</a>
   </li>
  
   <li class="list di">
     <a href="/tags/kubelet/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Kubelet</a>
   </li>
  
   <li class="list di">
     <a href="/tags/volume/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Volume</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      <script src="https://utteranc.es/client.js" repo="ZhongsJie96/ZhongsJie96.github.io" issue-term="pathname"
        label="Comment" theme="github-light" crossorigin="anonymous" async>
        </script>
    </div>
  </div>

  <aside class="w-30-l mt6-l">




</aside>

</article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
    <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://blogs.atomage.cn">
      &copy;  Atomage's Blog  2022-2023 
    </a>
    <div>
<div class="ananke-socials">
  
    
    <a href="https://github.com/ZhongsJie96" target="_blank" rel="noopener" class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" aria-label="follow on GitHubâ€”â€”Opens in a new window">
      
        <span class="icon"><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>
</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
    <a href="https://beian.miit.gov.cn/" class="link db f6 pa2 br3 bg-mid-gray white dim w4 tc"> èœ€ICPå¤‡2022025742å· </a>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HVT9CMYGB1"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-HVT9CMYGB1', { 'anonymize_ip': false });
}
</script>

  </div>
</footer>

  </body>
</html>
